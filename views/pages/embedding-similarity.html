<div x-data="{ textA: '', textB: '', similarity: null }">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="w-full">
            {{ template "views/partials/large-textarea" "textA" }}
        </div>
        <div class="w-full">
            {{ template "views/partials/large-textarea" "textB" }}
        </div>
    </div>
    <div class="w-full flex flex-col items-center">
        <button
            class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
            @click="similarity = await getSimilarity(textA, textB)"
        >
            Compare
        </button>
        <p x-show="similarity" x-text="`Similarity: ${similarity}`"></p>
    </div>

    <script src="https://unpkg.com/mathjs"></script>
    <script>
        function getEmbedding(text) {
            return fetch('/api/run/@cf/baai/bge-large-en-v1.5', {
                method: 'POST',
                body: JSON.stringify({ text }),
            })
                .then(r => r.json())
                .catch(e => console.error(e));
        }

        function calculateCosineSimilarity(vectorA, vectorB) {
            let dotProduct = math.dot(vectorA, vectorB);

            let magnitudeA = math.norm(vectorA);
            let magnitudeB = math.norm(vectorB);

            let cosineSimilarity = dotProduct / (magnitudeA * magnitudeB);

            return cosineSimilarity;
        }

        async function getSimilarity(textA, textB) {
            const [embeddingA, embeddingB] = await Promise.all([
                getEmbedding(textA),
                getEmbedding(textB),
            ]);

            const similarity = calculateCosineSimilarity(
                math.matrix(embeddingA.result.data[0]),
                math.matrix(embeddingB.result.data[0])
            );

            return similarity;
        }
    </script>
</div>
