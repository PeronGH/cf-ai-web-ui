<div x-data="{ prompt: '', loading: false, abortController: null }">
    <textarea
        class="border-2 rounded-lg w-full resize-none p-2"
        rows="10"
        x-model="prompt"
        x-ref="textinput"
        placeholder="Type here..."
        @keydown.cmd.enter.prevent="await generateTextAndUpdateUI($data)"
        @keydown.ctrl.enter.prevent="await generateTextAndUpdateUI($data)"
    ></textarea>

    <div class="mt-2 w-full flex justify-center gap-4">
        <button
            class="bg-blue-500 disabled:bg-yellow-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
            x-text="loading ? 'Stop' : 'Generate'"
            :disabled="!prompt"
            @click="await generateTextAndUpdateUI($data)"
        ></button>
        <button
            class="bg-blue-500 disabled:bg-yellow-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
            @click="prompt = wrapSelectedText($refs.textinput, '[INST]', '[/INST]')"
        >
            As Instruction
        </button>

        <button
            class="bg-blue-500 disabled:bg-yellow-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
            @click="prompt = wrapSelectedText($refs.textinput, '<s>', '</s>')"
        >
            As Conversation
        </button>
    </div>
</div>

{{ template "views/partials/generate-text-script" }}

<script>
    'use strict';

    async function generateTextAndUpdateUI($data) {
        if ($data.loading) {
            $data.abortController.abort();
            return;
        }

        $data.loading = true;
        $data.abortController = new AbortController();

        const tokenStream = generateText(
            $data.prompt,
            $data.abortController.signal
        );

        for await (const token of tokenStream) {
            $data.prompt += token;
        }

        $data.loading = false;
    }

    function wrapSelectedText(textarea, prefix, suffix) {
        const startPos = textarea.selectionStart;
        const endPos = textarea.selectionEnd;

        if (startPos === endPos) {
            return prefix + textarea.value + suffix;
        }

        return (
            textarea.value.substring(0, startPos) +
            prefix +
            textarea.value.substring(startPos, endPos) +
            suffix +
            textarea.value.substring(endPos, textarea.value.length)
        );
    }
</script>
